<!DOCTYPE html>
<html>
<head>
  <title>회원가입/로그인 + 채팅</title>
  <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
</head>
<body>
<h2>회원가입</h2>
<input id="signup-username" placeholder="아이디">
<input id="signup-password" type="password" placeholder="비밀번호">
<button onclick="signup()">회원가입</button>
<div id="signup-result"></div>
<hr>
<h2>로그인</h2>
<input id="login-username" placeholder="아이디">
<input id="login-password" type="password" placeholder="비밀번호">
<button onclick="login()">로그인</button>
<div id="login-result"></div>
<hr>
<h2>채팅</h2>
<input id="chat-content" placeholder="메시지">
<button onclick="sendMessage()">전송</button>
<ul id="messages"></ul>

<script>
  let stompClient = null;
  let token = null;

  function signup() {
    const username = document.getElementById('signup-username').value;
    const password = document.getElementById('signup-password').value;
    fetch('/auth/signup', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({username, password})
    })
            .then(res => res.text())
            .then(msg => document.getElementById('signup-result').innerText = msg);
  }

  function login() {
    const username = document.getElementById('login-username').value;
    const password = document.getElementById('login-password').value;
    fetch('/auth/login', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({username, password})
    })
            .then(res => res.text())
            .then(msg => {
              document.getElementById('login-result').innerText = msg;
              if (msg.includes('성공')) {
                connect();
              }
            });
  }

  function connect() {
    var socket = new SockJS('/ws-chat');
    stompClient = Stomp.over(socket);
    stompClient.connect({}, function(frame) {
      stompClient.subscribe('/topic/messages', function(message) {
        var msg = JSON.parse(message.body);
        var li = document.createElement('li');
        li.innerText = msg.sender + ': ' + msg.content;
        document.getElementById('messages').appendChild(li);
      });
    });
  }

  function sendMessage() {
    var content = document.getElementById('chat-content').value;
    stompClient.send("/app/chat.send", {}, JSON.stringify({content: content}));
  }
</script>
</body>
</html>